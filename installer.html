<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>EQ Character Manager - Setup Wizard</title>
  <style>
    /* Prevent horizontal overflow without clipping content */
    *, *::before, *::after { box-sizing: border-box; }
    html { overflow-x: hidden; }
    :root { --muted:#666; }
    body { font-family: system-ui, sans-serif; margin: 16px; }
    h2 { margin: 6px 0 14px; }
    .step { display:none; }
    .step.active { display:block; }
    .row { display:flex; gap:10px; align-items:center; margin: 10px 0; min-width: 0; }
    .row > * { flex: 1; min-width: 0; }
    input[type="text"], input[type="password"] { width:100%; padding:8px; }
    input[type="text"], input[type="password"], button { max-width: 100%; }
    button { padding:8px 12px; }
    .note { color: var(--muted); font-size: 12px; }
    .actions { display:flex; justify-content: space-between; gap:10px; margin-top: 16px; width: 100%; }
    .actions .spacer { flex:1; min-width: 0; }
    .invalid { outline: 2px solid #d33; }
    ol { padding-left: 18px; }
    .small { font-size:12px; color:#444; }
    .callout { margin-top:12px; padding:12px 14px; border-left:4px solid #2563eb; background:#f0f6ff; color:#1e3a8a; font-size:13px; font-weight:600; }
    .inline-btn { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #2563eb; border-radius:999px; background:#2563eb; color:#fff; font-size:12px; font-weight:600; cursor:pointer; transition:background 0.15s ease, transform 0.15s ease; }
    .inline-btn:hover { background:#1d4ed8; transform:translateY(-1px); }
    .inline-btn:focus-visible { outline:3px solid #bfdbfe; outline-offset:2px; }
    .walkthrough-gallery { display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:18px; margin:18px 0 8px; }
    .walkthrough-gallery figure { position:relative; background:#f8f9fb; border:1px solid #d1d9e6; border-radius:8px; padding:16px; display:flex; flex-direction:column; gap:14px; box-shadow:0 3px 6px rgba(15,23,42,0.12); }
    .walkthrough-gallery img { width:100%; border-radius:6px; border:1px solid #c4ccd9; cursor:zoom-in; transition:transform 0.18s ease; }
    .walkthrough-gallery img:focus-visible { outline:3px solid #2563eb; outline-offset:2px; }
    .walkthrough-gallery img:hover { transform:scale(1.02); }
    .walkthrough-gallery figcaption { font-size:13px; color:#1f2937; line-height:1.5; font-weight:600; }
    .step-badge { position:absolute; top:14px; left:18px; background:#2563eb; color:#fff; font-size:13px; font-weight:700; padding:5px 11px; border-radius:999px; letter-spacing:0.03em; }
    .walkthrough-modal { position:fixed; inset:0; background:rgba(15,23,42,0.85); display:flex; align-items:center; justify-content:center; padding:40px 32px; z-index:999; opacity:0; pointer-events:none; transition:opacity 0.2s ease; }
    .walkthrough-modal.open { opacity:1; pointer-events:auto; }
    .walkthrough-modal__inner { position:relative; max-width:1200px; width:100%; max-height:90vh; background:#0f172a; border-radius:12px; padding:28px 32px 32px; display:flex; flex-direction:column; gap:18px; box-shadow:0 12px 36px rgba(15,23,42,0.45); }
    .walkthrough-modal__img { width:100%; max-height:70vh; object-fit:contain; border-radius:8px; background:#1e293b; }
    .walkthrough-modal__caption { font-size:15px; color:#f8fafc; line-height:1.6; }
    .walkthrough-modal__close { position:absolute; top:12px; right:12px; background:rgba(15,23,42,0.6); color:#f8fafc; border:none; border-radius:999px; width:36px; height:36px; font-size:22px; cursor:pointer; transition:background 0.15s ease; }
    .walkthrough-modal__close:hover { background:rgba(37,99,235,0.75); }
    .walkthrough-modal__close:focus-visible { outline:3px solid #bfdbfe; outline-offset:2px; }
  </style>
  <script>
    function byId(id){ return document.getElementById(id); }
    function isLikelyWebhookUrl(url){
      try{
        const u = new URL(String(url||'').trim());
        if (u.protocol !== 'https:' && u.protocol !== 'http:') return false;
        if (!u.hostname) return false;
        if (!u.pathname || u.pathname === '/') return false;
        return true;
      }catch{ return false; }
    }
    let step = 0;
    const maxStep = 4; // 0..4
    function showStep(i){
      step = Math.max(0, Math.min(maxStep, i));
      for (let s=0; s<=maxStep; s++){
        const el = byId('step'+s);
        if (el) el.classList.toggle('active', s===step);
      }
      renderButtons();
    }
    function renderButtons(){
      byId('back').disabled = (step === 0);
      const next = byId('next');
      const finish = byId('finish');
      next.style.display = (step < maxStep) ? '' : 'none';
      finish.style.display = (step === maxStep) ? '' : 'none';
      next.disabled = !canProceed(step);
    }
    async function init(){
      try{
        const { settings } = await window.EQCM.getSettings();
        byId('sheetUrl').value = settings.sheetUrl || '';
        byId('webhookUrl').value = settings.webhookUrl || settings.appsScriptUrl || '';
        byId('logsDir').value = settings.logsDir || '';
        byId('baseDir').value = settings.baseDir || '';
        byId('localSheetsDir').value = settings.localSheetsDir || '';
      }catch{}
      attachHandlers();
      showStep(0);
      syncWalkthroughCaptions();
    }
    function attachHandlers(){
      ['sheetUrl','webhookUrl','logsDir','baseDir','localSheetsDir'].forEach(id => {
        const el = byId(id);
        el.addEventListener('input', renderButtons);
      });
    }
    async function pick(which){
      const res = await window.EQCM.browseFolder(which);
      if (res && res.path){ byId(which).value = res.path; renderButtons(); }
    }
    async function savePartial(fields){
      await window.EQCM.setSettings(fields);
    }
    async function next(){
      if (!canProceed(step)) return;
      if (step === 0){ await savePartial({ sheetUrl: byId('sheetUrl').value.trim() }); }
      if (step === 1){ 
        const webhookUrl = byId('webhookUrl').value.trim();
        await savePartial({ webhookUrl, appsScriptUrl: webhookUrl, remoteSheetsEnabled: true }); 
      }
      if (step === 2){ await savePartial({ logsDir: byId('logsDir').value.trim() }); }
      if (step === 3){ await savePartial({ baseDir: byId('baseDir').value.trim() }); }
      if (step === 4){ await savePartial({ localSheetsDir: byId('localSheetsDir').value.trim(), localSheetsEnabled: true }); }
      showStep(step+1);
    }
    function back(){ showStep(step-1); }
    async function finish(){
      await savePartial({ onboardingCompleted: true });
      window.close();
    }
    async function validateSheetUrl(){
      const el = byId('sheetUrl');
      const url = el.value.trim();
      const { sheetId } = await window.EQCM.deriveSheetId(url);
      const ok = !!sheetId;
      el.classList.toggle('invalid', !ok && url.length>0);
      return ok;
    }
    function validateApiUrl(){
      const el = byId('webhookUrl');
      const url = el.value.trim();
      const ok = isLikelyWebhookUrl(url);
      el.classList.toggle('invalid', !ok && url.length>0);
      return ok;
    }
    function canProceed(s){
      if (s===0) return byId('sheetUrl').value.trim().length>0; // accept and parse later
      if (s===1) return isLikelyWebhookUrl(byId('webhookUrl').value.trim());
      if (s===2) return byId('logsDir').value.trim().length>0;
      if (s===3) return byId('baseDir').value.trim().length>0;
      if (s===4) return true; // local CSV optional; explain below
      return true;
    }
    async function openSheetsNew(){
      // Use a direct Google Sheets create URL for broader compatibility
      // Some environments block or fail to resolve the .new domain
      const url = 'https://docs.google.com/spreadsheets/u/0/create';
      try{
        const ok = await window.EQCM.openExternal(url);
        if (!ok){
          // Fallback: attempt to open in a new window/tab
          try { window.open(url, '_blank'); } catch {}
        }
      } catch {
        try { window.open(url, '_blank'); } catch {}
      }
    }
    function openExpressGuide(){ window.EQCM.openExternal('https://expressjs.com/en/starter/installing.html'); }

    let walkthroughModal = null;
    let lastWalkthroughFocus = null;
    function showWalkthroughImage(target, caption){
      try{
        walkthroughModal = walkthroughModal || byId('walkthroughModal');
        if (!walkthroughModal) return;
        const img = byId('walkthroughModalImg');
        const cap = byId('walkthroughModalCaption');
        let src = '';
        let desc = caption || '';
        if (typeof target === 'string'){
          src = target;
          if (!desc) desc = '';
          lastWalkthroughFocus = document.activeElement;
        } else if (target && typeof target.getAttribute === 'function'){
          src = target.getAttribute('src') || '';
          desc = target.getAttribute('data-desc') || desc || '';
          lastWalkthroughFocus = target;
        } else {
          return;
        }
        if (img){ img.src = src; img.alt = desc || ''; }
        if (cap){
          if (desc){ cap.textContent = desc; cap.style.display=''; }
          else { cap.textContent=''; cap.style.display='none'; }
        }
        walkthroughModal.classList.add('open');
        walkthroughModal.setAttribute('aria-hidden','false');
        const closeBtn = walkthroughModal.querySelector('.walkthrough-modal__close');
        if (closeBtn) closeBtn.focus({ preventScroll:true });
      }catch{}
    }
    function closeWalkthroughImage(){
      try{
        walkthroughModal = walkthroughModal || byId('walkthroughModal');
        if (!walkthroughModal) return;
        walkthroughModal.classList.remove('open');
        walkthroughModal.setAttribute('aria-hidden','true');
        const img = byId('walkthroughModalImg');
        if (img){ img.src = ''; }
        if (lastWalkthroughFocus && typeof lastWalkthroughFocus.focus === 'function'){
          try { lastWalkthroughFocus.focus({ preventScroll:true }); } catch { try { lastWalkthroughFocus.focus(); } catch {} }
        }
        lastWalkthroughFocus = null;
      }catch{}
    }
    document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') closeWalkthroughImage(); });
    function syncWalkthroughCaptions(){
      try{
        document.querySelectorAll('.walkthrough-gallery figure').forEach(fig => {
          const img = fig.querySelector('img[data-desc]');
          const cap = fig.querySelector('figcaption');
          if (img && cap){
            const text = img.getAttribute('data-desc') || '';
            cap.textContent = text;
          }
        });
      }catch{}
    }
  </script>
</head>
<body>
  <h2>Setup Wizard</h2>

  <div id="step0" class="step">
    <h3>1. Create your Google Sheet</h3>
    <p class="small">Create a spreadsheet that will hold Zone Tracker, CoV Faction, and inventory tabs.</p>
    <div class="row">
      <button onclick="openSheetsNew()">Create new sheet</button>
      <div class="note">Opens a new Google Sheet in your browser.</div>
    </div>
    <label>Spreadsheet URL</label>
    <input id="sheetUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/<ID>/edit" onblur="validateSheetUrl()"/>
    <div class="note">Paste the sheet URL from your browser. We’ll use it for quick access links.</div>
  </div>

  <div id="step1" class="step">
    <h3>2. Deploy the webhook server</h3>
    <p class="small">Host the EQCM Node/Express webhook so it can keep your Google Sheet in sync.</p>
    <ol class="small">
      <li>Install Node.js 18 or newer on the target machine (or use a host such as Render/Fly/Heroku).</li>
      <li>Deploy the service in <code>server/index.js</code> (<code>npm install</code> then <code>npm run api</code> locally, or push the repo to your host).</li>
      <li>Provide the required environment variables: <code>GOOGLE_SHEET_ID</code>, <code>GOOGLE_SERVICE_ACCOUNT_JSON</code> (or <code>GOOGLE_APPLICATION_CREDENTIALS</code>), and optional <code>WEBHOOK_SECRET</code>.</li>
      <li>Expose the service over HTTP(S) and copy the full <code>/webhook</code> endpoint URL.</li>
    </ol>
    <div class="callout">
      Need deployment guidance?
      <button class="inline-btn" type="button" onclick="openExpressGuide()">Express guide</button>
    </div>
    <label>Webhook URL</label>
    <input id="webhookUrl" type="text" placeholder="https://your-api.example.com/webhook" oninput="validateApiUrl()"/>
    <div class="note">Example: https://your-render-app.onrender.com/webhook</div>
  </div>
  <div id="step2" class="step">
    <h3>3. Pick your EverQuest logs folder</h3>
    <div class="row">
      <input id="logsDir" type="text" placeholder="Select EverQuest/logs folder"/>
      <button onclick="pick('logsDir')">Browse…</button>
    </div>
    <div class="note">The app scans this directory for zone changes and considerations.</div>
  </div>

  <div id="step3" class="step">
    <h3>4. Pick your EverQuest base folder</h3>
    <div class="row">
      <input id="baseDir" type="text" placeholder="Select base EverQuest folder"/>
      <button onclick="pick('baseDir')">Browse…</button>
    </div>
    <div class="note">Used for context and locating related files.</div>
  </div>

  <div id="step4" class="step">
    <h3>5. Local CSV output (optional)</h3>
    <div class="row">
      <input id="localSheetsDir" type="text" placeholder="Where CSVs are written (optional)"/>
      <button onclick="pick('localSheetsDir')">Browse…</button>
    </div>
    <div class="note">This folder stores CSV exports. The CoV Faction sheet in Google Sheets is synced from <b>CoV Faction.csv</b> here. If left blank, the app uses its default folder.</div>
  </div>

  <div id="walkthroughModal" class="walkthrough-modal" role="dialog" aria-modal="true" aria-labelledby="walkthroughModalCaption" aria-hidden="true" onclick="closeWalkthroughImage()">
    <div class="walkthrough-modal__inner" onclick="event.stopPropagation();">
      <button type="button" class="walkthrough-modal__close" aria-label="Close walkthrough screenshot" onclick="closeWalkthroughImage()">×</button>
      <img id="walkthroughModalImg" class="walkthrough-modal__img" src="" alt=""/>
      <div id="walkthroughModalCaption" class="walkthrough-modal__caption"></div>
    </div>
  </div>

  <div class="actions">
    <button id="back" onclick="back()">Back</button>
    <div class="spacer"></div>
    <button id="next" onclick="next()">Next</button>
    <button id="finish" onclick="finish()" style="display:none">Finish</button>
  </div>

  <script>init();</script>
</body>
</html>

