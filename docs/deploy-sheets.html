<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Deploy Google Sheets backend</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 18px; line-height: 1.45; max-width: 900px; }
    code, pre { background: #f5f5f5; padding: 2px 4px; border-radius: 4px; }
    pre { padding: 12px; overflow: auto; }
    h2 { margin-top: 24px; }
    ol li { margin-bottom: 8px; }
  </style>
</head>
<body>
  <h1>Google Sheets Backend — Setup</h1>
  <p>This page helps you deploy the Apps Script that the tray app calls. It also supports per-character <b>Push inventory to sheet</b> tabs like your screenshot layout.</p>

  <h2>1) Create a Spreadsheet</h2>
  <ol>
    <li>Create a new Google Sheet (or reuse an existing one).</li>
    <li>Copy its URL and paste it into the app <b>Settings → Spreadsheet URL</b>.</li>
  </ol>

  <h2>2) Create an Apps Script Project</h2>
  <ol>
    <li>Open <b>Extensions → Apps Script</b> in the Sheet.</li>
    <li>Replace <b>Code.gs</b> with the contents below.</li>
    <li>Set <b>CONFIG.SECRET</b> to your shared secret (optional) — match it in the app settings.</li>
    <li>Deploy: <b>Deploy → New deployment → Web app</b> → Execute as <i>Me</i> → Who has access <i>Anyone with link</i>.</li>
    <li>Copy the <b>/exec</b> URL into the app <b>Settings → Apps Script /exec URL</b>.</li>
  </ol>

  <h2>3) Code.gs</h2>
  <p>You can copy the file at <code>docs/Code.gs</code> from this repo, or paste the snippet below into your Apps Script project.</p>
  <pre id="code"></pre>

  <script>
  const code = `// Code.gs — Google Apps Script backend for EQ Character Manager
const CONFIG = {
  SECRET: '',              // Optional: set a shared secret string; leave blank to disable check
  ZONES_SHEET: 'Zone Tracker',
  FACTION_SHEET: 'CoV Faction',
  INV_SUMMARY_SHEET: 'Inventory Summary',
  INV_ITEMS_SHEET: 'Inventory Items' // optional catch-all
};

function doPost(e){
  try{
    const body = JSON.parse(e.postData && e.postData.contents || '{}');
    if (CONFIG.SECRET && String(body.secret||'') !== CONFIG.SECRET) {
      return ContentService.createTextOutput('Unauthorized').setMimeType(ContentService.MimeType.TEXT).setResponseCode(401);
    }
    const ss = SpreadsheetApp.getActiveSpreadsheet();

    if (body.action === 'pushInventorySheet'){
      return respond_(pushInventorySheet_(ss, body));
    }
    if (body.action === 'replaceAll'){
      replaceAll_(ss, body);
      return respond_({ ok: true, mode: 'replaceAll' });
    }

    const upserts = body.upserts || {};
    if (upserts.zones)    upsertZones_(ss, upserts.zones);
    if (upserts.factions) upsertFactions_(ss, upserts.factions);
    if (upserts.inventory) upsertInventorySummary_(ss, upserts.inventory);
    if (upserts.inventoryDetails) upsertInventoryDetails_(ss, upserts.inventoryDetails);
    return respond_({ ok: true });
  }catch(err){
    return respond_({ ok:false, error: String(err && err.stack || err) }, 500);
  }
}

function respond_(obj, code){
  const out = ContentService.createTextOutput(JSON.stringify(obj));
  out.setMimeType(ContentService.MimeType.JSON);
  if (code) out.setResponseCode(code);
  return out;
}

function getOrMakeSheet_(ss, name){
  let sh = ss.getSheetByName(name);
  if (!sh) sh = ss.insertSheet(name);
  return sh;
}

function ensureHeader_(sh, header){
  const existing = sh.getRange(1,1,1,sh.getMaxColumns()).getValues()[0].filter(String);
  if (existing.join('\\t') !== header.join('\\t')){
    sh.clearContents();
    sh.getRange(1,1,1,header.length).setValues([header]);
  }
}

function upsertRowsByKey_(sh, header, keyCol, rows){
  ensureHeader_(sh, header);
  const idx = header.indexOf(keyCol) + 1;
  const data = sh.getDataRange().getValues();
  const map = new Map();
  for (let r=1; r<data.length; r++){
    const k = String(data[r][idx-1]||'');
    if (k) map.set(k, r+1);
  }
  rows.forEach(row => {
    const key = String(row[header.indexOf(keyCol)]||'');
    if (!key) return;
    let r = map.get(key);
    if (r){
      sh.getRange(r,1,1,header.length).setValues([row]);
    } else {
      sh.appendRow(row);
      map.set(key, sh.getLastRow());
    }
  });
}

function writeAllRows_(sh, header, rows){
  sh.clearContents();
  sh.getRange(1,1,1,header.length).setValues([header]);
  if (rows && rows.length){
    sh.getRange(2,1,rows.length,header.length).setValues(rows);
  }
}

function upsertZones_(ss, rows){
  const header = ['Character','Last Zone','Zone Time (UTC)','Zone Time (Local)','Device TZ','Source Log File'];
  const sh = getOrMakeSheet_(ss, CONFIG.ZONES_SHEET);
  const data = rows.map(o => [o.character,o.zone,o.utc,o.local,o.tz,o.source]);
  // Key by Source Log File so same character on different servers are separate rows
  upsertRowsByKey_(sh, header, 'Source Log File', data);
}

function replaceZones_(ss, rows){
  const header = ['Character','Last Zone','Zone Time (UTC)','Zone Time (Local)','Device TZ','Source Log File'];
  const sh = getOrMakeSheet_(ss, CONFIG.ZONES_SHEET);
  const data = (rows||[]).map(o => [o.character,o.zone,o.utc,o.local,o.tz,o.source]);
  writeAllRows_(sh, header, data);
}

function upsertFactions_(ss, rows){
  const header = ['Character','Standing','Score','Mob','Consider Time (UTC)','Consider Time (Local)','Notes'];
  const sh = getOrMakeSheet_(ss, CONFIG.FACTION_SHEET);
  const data = rows.map(o => [o.character,o.standing,o.score,o.mob,o.utc,o.local,(o.standingDisplay||'')]);
  upsertRowsByKey_(sh, header, 'Character', data);
}

function replaceFactions_(ss, rows){
  const header = ['Character','Standing','Score','Mob','Consider Time (UTC)','Consider Time (Local)','Notes'];
  const sh = getOrMakeSheet_(ss, CONFIG.FACTION_SHEET);
  const data = (rows||[]).map(o => [o.character,o.standing,o.score,o.mob,o.utc,o.local,(o.standingDisplay||'')]);
  writeAllRows_(sh, header, data);
}

function upsertInventorySummary_(ss, rows){
  const header = ['Character','Inventory File','Source Log File','Created (UTC)','Modified (UTC)',
                  'Vial of Velium Vapors','Velium Vial Count','Leatherfoot Raider Skullcap','Shiny Brass Idol',
                  'Ring of Shadows Count','Reaper of the Dead','Pearl Count','Peridot Count',
                  'MB Class Five','MB Class Four','MB Class Three','MB Class Two','MB Class One','Larrikan\\'s Mask'];
  const sh = getOrMakeSheet_(ss, CONFIG.INV_SUMMARY_SHEET);
  const data = rows.map(o => [o.character,o.file,o.logFile,o.created,o.modified,
                              o.raidKit?.vialVeliumVapors||'', o.raidKit?.veliumVialCount||0, o.raidKit?.leatherfootSkullcap||'',
                              o.raidKit?.shinyBrassIdol||'', o.raidKit?.ringOfShadowsCount||0, o.raidKit?.reaperOfTheDead||'',
                              o.raidKit?.pearlCount||0, o.raidKit?.peridotCount||0,
                              o.raidKit?.mbClassFive||0, o.raidKit?.mbClassFour||0, o.raidKit?.mbClassThree||0,
                              o.raidKit?.mbClassTwo||0, o.raidKit?.mbClassOne||0, o.raidKit?.larrikansMask||'' ]);
  upsertRowsByKey_(sh, header, 'Character', data);
}

function replaceInventorySummary_(ss, rows){
  const header = ['Character','Inventory File','Source Log File','Created (UTC)','Modified (UTC)',
                  'Vial of Velium Vapors','Velium Vial Count','Leatherfoot Raider Skullcap','Shiny Brass Idol',
                  'Ring of Shadows Count','Reaper of the Dead','Pearl Count','Peridot Count',
                  'MB Class Five','MB Class Four','MB Class Three','MB Class Two','MB Class One','Larrikan\\'s Mask'];
  const sh = getOrMakeSheet_(ss, CONFIG.INV_SUMMARY_SHEET);
  const data = (rows||[]).map(o => [o.character,o.file,o.logFile,o.created,o.modified,
                              o.raidKit?.vialVeliumVapors||'', o.raidKit?.veliumVialCount||0, o.raidKit?.leatherfootSkullcap||'',
                              o.raidKit?.shinyBrassIdol||'', o.raidKit?.ringOfShadowsCount||0, o.raidKit?.reaperOfTheDead||'',
                              o.raidKit?.pearlCount||0, o.raidKit?.peridotCount||0,
                              o.raidKit?.mbClassFive||0, o.raidKit?.mbClassFour||0, o.raidKit?.mbClassThree||0,
                              o.raidKit?.mbClassTwo||0, o.raidKit?.mbClassOne||0, o.raidKit?.larrikansMask||'' ]);
  writeAllRows_(sh, header, data);
}

function upsertInventoryDetails_(ss, rows){
  const header = ['Character','Inventory File','Created (UTC)','Modified (UTC)','Location','Name','ID','Count','Slots'];
  const sh = getOrMakeSheet_(ss, CONFIG.INV_ITEMS_SHEET);
  ensureHeader_(sh, header);
  const data = [];
  rows.forEach(o => {
    (o.items||[]).forEach(it => {
      data.push([o.character, o.file, o.created, o.modified, it.Location, it.Name, it.ID, it.Count, it.Slots]);
    });
  });
  if (data.length) sh.getRange(sh.getLastRow()+1,1,data.length,header.length).setValues(data);
}

function replaceInventoryDetails_(ss, rows){
  const header = ['Character','Inventory File','Created (UTC)','Modified (UTC)','Location','Name','ID','Count','Slots'];
  const sh = getOrMakeSheet_(ss, CONFIG.INV_ITEMS_SHEET);
  const data = [];
  (rows||[]).forEach(o => {
    (o.items||[]).forEach(it => {
      data.push([o.character, o.file, o.created, o.modified, it.Location, it.Name, it.ID, it.Count, it.Slots]);
    });
  });
  writeAllRows_(sh, header, data);
}

function replaceAll_(ss, body){
  const up = body.upserts || body || {};
  if (up.zones)    replaceZones_(ss, up.zones);
  if (up.factions) replaceFactions_(ss, up.factions);
  if (up.inventory) replaceInventorySummary_(ss, up.inventory);
  if (up.inventoryDetails) replaceInventoryDetails_(ss, up.inventoryDetails);
}

// Create a NEW sheet tab with a character's inventory (similar to screenshot)
function pushInventorySheet_(ss, body){
  const character = String(body.character||'').trim();
  const baseName = String(body.sheetName||'').trim() || ('Inventory - ' + character);
  const info = body.info || {};
  const items = body.items || [];
  if (!character) return { ok:false, error: 'Missing character' };

  // Unique sheet name
  let name = baseName, n=1;
  while (ss.getSheetByName(name)) { name = baseName + ' (' + (++n) + ')'; }
  const sh = ss.insertSheet(name);

  // Header rows (A1:D1, A2:D2) to match screenshot layout
  sh.getRange(1,1,1,4).setValues([['Inventory for','File','Created On','Modified On']]);
  sh.getRange(2,1,1,4).setValues([[character, info.file || '', info.created || '', info.modified || '']]);

  // Blank spacer row
  sh.getRange(3,1,1,1).setValue('');

  // Table header & data
  const header = ['Location','Name','ID','Count','Slots'];
  sh.getRange(5,1,1,header.length).setValues([header]);
  const data = items.map(it => [it.Location, it.Name, it.ID, it.Count, it.Slots]);
  if (data.length) sh.getRange(6,1,data.length,header.length).setValues(data);

  // Formatting
  sh.setFrozenRows(5);
  sh.autoResizeColumns(1, header.length);

  return { ok:true, sheet: name };
}`;
  document.getElementById('code').textContent = code;
  </script>
</body>
</html>
