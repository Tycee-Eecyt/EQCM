<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>EQ Character Manager â€” CoV Mob List</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    label { display:block; margin-top:10px; font-weight:600; }
    input[type="text"], input[type="password"], select { width: 100%; padding: 8px; }
    button { padding:8px 12px; }
    .small { font-size: 12px; color:#555; }
    .grid { display:grid; grid-template-columns: 200px 1fr auto; gap: 8px 12px; align-items:center; }
    .listbox{border:1px solid #ddd;padding:8px;max-height:200px;overflow:auto}
  </style>
</head>
<body>
  <h2>CoV Mob List</h2>
  <p class="small">View defaults, see the merged effective list, and add/remove entries. Changes take effect immediately.</p>

  <details>
    <summary>Default list (<span id="covDefaultCount">0</span>)</summary>
    <div id="covDefaults" class="listbox" style="white-space:pre-wrap; margin-top:6px"></div>
  </details>

  <h3 style="margin-top:16px">Merged effective list (<span id="covMergedCount">0</span>)</h3>
  <div id="covMerged" class="listbox" style="white-space:pre-wrap"></div>

  <div class="grid" style="margin-top:16px">
    <label>Add mobs</label>
    <input id="covAddInput" type="text" placeholder="e.g., a wyvern"/>
    <button onclick="covAdd()">Add</button>

    <div></div>
    <div id="covAdditions" class="listbox"></div>
    <div></div>

    <label>Remove default mobs</label>
    <input id="covRemoveInput" type="text" placeholder="Exact name from defaults"/>
    <button onclick="covRemove()">Remove</button>

    <div></div>
    <div id="covRemovals" class="listbox"></div>
    <div></div>
  </div>

  <div style="margin-top:12px; display:flex; gap:8px">
    <button onclick="saveAndClose()">Save & Close</button>
    <button onclick="resetOverrides()">Reset Overrides</button>
  </div>

  <script>
    const els = {};
    function byId(id){ return els[id] || (els[id] = document.getElementById(id)); }
    let _cov = { defaults: [], merged: [], additions: [], removals: [] };

    async function load(){
      const lists = await window.EQCM.getCovLists();
      _cov = lists || { defaults: [], merged: [], additions: [], removals: [] };
      render();
    }
    function render(){
      byId('covDefaultCount').innerText = String((_cov.defaults||[]).length);
      byId('covDefaults').innerText = (_cov.defaults||[]).join('\n');
      byId('covMergedCount').innerText = String((_cov.merged||[]).length);
      byId('covMerged').innerText = (_cov.merged||[]).join('\n');
      renderBoxes();
    }
    function renderBoxes(){
      const addBox = byId('covAdditions'); addBox.innerHTML='';
      (_cov.additions||[]).forEach((name, i) => {
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
        const span = document.createElement('span'); span.textContent = name; row.appendChild(span);
        const btn = document.createElement('button'); btn.textContent = 'Remove'; btn.onclick = async () => {
          _cov.additions.splice(i,1);
          await window.EQCM.setSettings({ covAdditions: _cov.additions });
          await refresh();
        }; row.appendChild(btn);
        addBox.appendChild(row);
      });
      const remBox = byId('covRemovals'); remBox.innerHTML='';
      (_cov.removals||[]).forEach((name, i) => {
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
        const span = document.createElement('span'); span.textContent = name; row.appendChild(span);
        const btn = document.createElement('button'); btn.textContent = 'Unhide'; btn.onclick = async () => {
          _cov.removals.splice(i,1);
          await window.EQCM.setSettings({ covRemovals: _cov.removals });
          await refresh();
        }; row.appendChild(btn);
        remBox.appendChild(row);
      });
    }
    async function refresh(){
      const lists = await window.EQCM.getCovLists();
      _cov = lists || _cov;
      render();
    }
    async function covAdd(){
      const v = byId('covAddInput').value.trim(); if (!v) return;
      byId('covAddInput').value = '';
      const next = Array.from(new Set([ ...(_cov.additions||[]), v ]));
      _cov.additions = next;
      await window.EQCM.setSettings({ covAdditions: next });
      await refresh();
    }
    async function covRemove(){
      const v = byId('covRemoveInput').value.trim(); if (!v) return;
      byId('covRemoveInput').value = '';
      const next = Array.from(new Set([ ...(_cov.removals||[]), v ]));
      _cov.removals = next;
      await window.EQCM.setSettings({ covRemovals: next });
      await refresh();
    }
    async function resetOverrides(){
      _cov.additions = [];
      _cov.removals = [];
      await window.EQCM.setSettings({ covAdditions: [], covRemovals: [] });
      await refresh();
    }
    async function saveAndClose(){
      await window.EQCM.setSettings({ covAdditions: _cov.additions||[], covRemovals: _cov.removals||[] });
      window.close();
    }
    load();
  </script>
</body>
</html>

