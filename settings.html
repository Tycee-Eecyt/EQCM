<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>EQ Character Manager — Settings</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    label { display:block; margin-top:10px; font-weight:600; }
    input[type="text"], input[type="password"], select { width: 100%; padding: 8px; }
    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex: 1; }
    button { padding:8px 12px; }
    /* Inline action buttons in the grid (Browse/Open) should match primary button sizing */
    .btn-inline { padding:8px 12px; font-size:14px; justify-self:start; width:auto; min-width:110px; }
    .small { font-size: 12px; color:#555; }
    .grid { display:grid; grid-template-columns: 200px 1fr auto; gap: 8px 12px; align-items:center; }
    .grid label { margin:0; }
  </style>
</head>
<body>
  <h2>EQ Character Manager — Settings</h2>
  <div class="grid">
    <label>Logs folder</label>
    <input id="logsDir" type="text" placeholder="Pick EverQuest/logs folder"/>
    <button class="btn-inline" onclick="pick('logsDir')">Browse…</button>

    <label>Base folder</label>
    <input id="baseDir" type="text" placeholder="Pick EverQuest base folder"/>
    <button class="btn-inline" onclick="pick('baseDir')">Browse…</button>

    <label>Local CSV output</label>
    <input id="localSheetsDir" type="text" placeholder="Where CSVs are written (optional)"/>
    <button class="btn-inline" onclick="pick('localSheetsDir')">Browse…</button>

    <label>Apps Script /exec URL</label>
    <input id="appsScriptUrl" type="text" placeholder="https://script.google.com/macros/s/XXXX/exec"/>
    <div class="small">Deploy your Google Apps Script as Web App and paste the /exec URL here.</div>

    <label>Webhook secret (optional)</label>
    <input id="appsScriptSecret" type="password" placeholder="Shared secret to validate webhook"/>
    <div></div>

    <label>Spreadsheet URL</label>
    <input id="sheetUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/&lt;ID&gt;/edit"/>
    <button class="btn-inline" onclick="openSheet()">Open</button>
  </div>

  <div style="margin-top:16px">
    <button onclick="saveAndClose()">Save & Close</button>
  </div>

  <p class="small" style="margin-top:12px">
    Use the tray menu → <b>Favorites…</b> to manage favorite characters and filtering.
  </p>

  <script>
    const els = {}; function byId(id){ return els[id] || (els[id] = document.getElementById(id)); }
    async function load(){
      const { settings } = await window.EQCM.getSettings();
      ['logsDir','baseDir','localSheetsDir','appsScriptUrl','appsScriptSecret','sheetUrl'].forEach(k => byId(k).value = settings[k] || '');
    }
    async function save(){
      const payload = {
        logsDir: byId('logsDir').value.trim(),
        baseDir: byId('baseDir').value.trim(),
        localSheetsDir: byId('localSheetsDir').value.trim(),
        appsScriptUrl: byId('appsScriptUrl').value.trim(),
        appsScriptSecret: byId('appsScriptSecret').value,
        sheetUrl: byId('sheetUrl').value.trim(),
        // Keep these enabled by default; removed from UI
        localSheetsEnabled: true,
        remoteSheetsEnabled: true
      };
      await window.EQCM.setSettings(payload);
    }
    async function saveAndClose(){ await save(); window.close(); }
    async function pick(which){
      const res = await window.EQCM.browseFolder(which);
      if (res && res.path) byId(which).value = res.path;
    }
    function openSheet(){
      let url = byId('sheetUrl').value.trim();
      if (!url) return;
      // Normalize: accept bare ID or URLs missing scheme
      const idOnly = /^[A-Za-z0-9_-]{20,}$/;
      if (idOnly.test(url)) url = `https://docs.google.com/spreadsheets/d/${url}/edit`;
      if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
      try { window.EQCM.openExternal(url); } catch {}
    }
    load();
  </script>
</body>
</html>
