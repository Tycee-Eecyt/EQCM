<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>EQ Character Manager â€” Raid Kit</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    label { display:block; margin-top:10px; font-weight:600; }
    input[type="text"], select { width: 100%; padding: 8px; }
    button { padding: 8px 12px; }
    .row { display:flex; gap:8px; align-items:center; }
    .list { border:1px solid #ddd; max-height:240px; overflow:auto; padding:8px; }
    .item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:4px 0; }
    .small { font-size: 12px; color:#555; }
  </style>
</head>
<body>
  <h2>Raid Kit</h2>
  <p class="small">Add items to track and choose whether to count how many or just presence. Example: add "Potion of Stinging Wort" and enable "Count".</p>

  <div class="row" style="margin:8px 0">
    <label style="margin:0">Character</label>
    <select id="character"></select>
    <button onclick="refreshCounts()">Refresh Counts</button>
  </div>

  <h3>Items</h3>
  <div class="row">
    <input id="newName" type="text" placeholder="Item name (e.g., Potion of Stinging Wort)"/>
    <label style="margin:0"><input type="checkbox" id="newCount"/> Count</label>
    <button onclick="addItem()">Add</button>
  </div>
  <div id="kitList" class="list" style="margin-top:8px"></div>

  <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
    <button onclick="saveAndClose()">Save & Close</button>
    <button onclick="resetCustom()">Reset Custom Items</button>
  </div>

  <script>
    let kit = { defaults: [], custom: [], hidden: [], merged: [] };
    let counts = [];
    let characters = [];

    async function load(){
      const data = await window.EQCM.getSettings();
      const res = await window.EQCM.getRaidKit();
      kit = res || { defaults: [], custom: [], hidden: [], merged: [] };
      characters = (data && data.characters) || [];
      const sel = document.getElementById('character');
      sel.innerHTML = '';
      characters.forEach(c => { const o = document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
      await refreshCounts();
      render();
    }
    async function refreshCounts(){
      const ch = document.getElementById('character').value || '';
      if (!ch){ counts = []; render(); return; }
      const res = await window.EQCM.getRaidKitCounts(ch);
      counts = (res && res.rows) || [];
      render();
    }
    function render(){
      const box = document.getElementById('kitList');
      box.innerHTML = '';
      const merged = kit.merged || [];
      merged.forEach((it, idx) => {
        const row = document.createElement('div'); row.className='item';
        const left = document.createElement('div');
        const name = document.createElement('div'); name.textContent = it.name; left.appendChild(name);
        const small = document.createElement('div'); small.className='small'; small.textContent = it.mode==='count' ? 'Count' : 'Present'; left.appendChild(small);
        row.appendChild(left);
        const right = document.createElement('div'); right.className='row';
        const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = (it.mode==='count'); chk.title='Count';
        chk.onchange = async () => { setItemMode(it.name, chk.checked?'count':'present'); };
        right.appendChild(chk);
        const span = document.createElement('span'); span.className='small';
        const found = (counts||[]).find(c => c.name===it.name);
        span.textContent = found ? (found.mode==='count' ? String(found.count||0) : (found.present?'Yes':'No')) : '';
        right.appendChild(span);
        const btnHide = document.createElement('button'); btnHide.textContent = 'Remove'; btnHide.onclick = async () => { removeItem(it.name); }; right.appendChild(btnHide);
        row.appendChild(right);
        box.appendChild(row);
      });
    }
    async function setItemMode(name, mode){
      // change in custom if exists; else add override
      const idx = (kit.custom||[]).findIndex(i => i.name===name);
      if (idx>=0) kit.custom[idx].mode = mode; else kit.custom.push({ name, mode });
      await window.EQCM.setRaidKit({ items: kit.custom, hidden: kit.hidden });
      kit = await window.EQCM.getRaidKit();
      await refreshCounts();
    }
    async function removeItem(name){
      // If in custom, delete; else hide default
      const i = (kit.custom||[]).findIndex(x => x.name===name);
      if (i>=0) kit.custom.splice(i,1); else kit.hidden = Array.from(new Set([...(kit.hidden||[]), name]));
      await window.EQCM.setRaidKit({ items: kit.custom, hidden: kit.hidden });
      kit = await window.EQCM.getRaidKit();
      await refreshCounts();
    }
    async function addItem(){
      const name = (document.getElementById('newName').value||'').trim();
      const count = document.getElementById('newCount').checked;
      if (!name) return;
      document.getElementById('newName').value=''; document.getElementById('newCount').checked=false;
      kit.custom = Array.from(new Set([ ...(kit.custom||[]), JSON.stringify({ name, mode: count?'count':'present' }) ])).map(s => JSON.parse(s));
      await window.EQCM.setRaidKit({ items: kit.custom, hidden: kit.hidden });
      kit = await window.EQCM.getRaidKit();
      await refreshCounts();
    }
    async function resetCustom(){
      kit.custom = []; kit.hidden = [];
      await window.EQCM.setRaidKit({ items: [], hidden: [] });
      kit = await window.EQCM.getRaidKit();
      await refreshCounts();
    }
    async function saveAndClose(){
      await window.EQCM.setRaidKit({ items: kit.custom, hidden: kit.hidden });
      window.close();
    }
    load();
  </script>
</body>
</html>

