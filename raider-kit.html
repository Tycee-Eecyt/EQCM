<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>EQ Character Manager — Raid Kit</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    input[type="text"], select { padding: 8px; }
    button { padding: 8px 12px; }
    .row { display:flex; gap:8px; align-items:center; }
    .list { border:1px solid #ddd; max-height:360px; overflow:auto; padding:8px; }
    .item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px solid #f1f1f1; }
    .small { font-size: 12px; color:#555; }
    #toast { position: fixed; right: 16px; bottom: 16px; background: rgba(30,30,30,0.92); color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 13px; display: none; z-index: 9999; }
  </style>
  <script>
    let kit = { defaults: [], custom: [], hidden: [], merged: [] };
    function setStatus(msg){ const el = document.getElementById('status'); if (el){ el.textContent = msg||''; if (msg){ setTimeout(()=>{ el.textContent=''; }, 1200); } } }
    async function load(){ const res = await window.EQCM.getRaidKit(); kit = res || { defaults: [], custom: [], hidden: [], merged: [] }; render(); }
    function normalizeCustom(list){
      const arr = Array.isArray(list)? list : [];
      return arr.map(o => ({ name: String(o.name||''), mode: (o.mode==='count'?'count':'present'), pattern: o.pattern||('^'+escapeRe(String(o.name||''))+'$') }))
               .filter(o => !!o.name);
    }
    function render(){
      const box = document.getElementById('kitList'); box.innerHTML = '';
      const mergedBase = Array.isArray(kit.merged) ? kit.merged.slice() : [];
      const customNorm = normalizeCustom(kit.custom);
      const byName = new Set(mergedBase.map(it => String(it.name)));
      const merged = mergedBase.concat(customNorm.filter(it => !byName.has(String(it.name))));
      merged.sort((a,b)=>a.name.localeCompare(b.name));
      merged.forEach((it, idx) => {
        const row = document.createElement('div'); row.className='item';
        const left = document.createElement('div');
        const isEditing = (window._editingIdx === idx);
        if (isEditing){
          const nameInp = document.createElement('input'); nameInp.type='text'; nameInp.id='edit-name-'+idx; nameInp.value=(window._editingName!=null?window._editingName:it.name); nameInp.style.minWidth='260px'; left.appendChild(nameInp);
          const modeSel = document.createElement('select'); modeSel.id='edit-mode-'+idx; ['present','count'].forEach(m=>{ const opt=document.createElement('option'); opt.value=m; opt.textContent=m.charAt(0).toUpperCase()+m.slice(1); if (it.mode===m) opt.selected=true; modeSel.appendChild(opt); }); left.appendChild(modeSel);
        } else {
          const name = document.createElement('div'); name.textContent = it.name; left.appendChild(name);
          const small = document.createElement('div'); small.className='small'; small.textContent = it.mode==='count' ? 'Count' : 'Present'; left.appendChild(small);
        }
        row.appendChild(left);
        const right = document.createElement('div'); right.className='row';
        if (isEditing){
          const btnSave = document.createElement('button'); btnSave.textContent='Save'; btnSave.onclick=async()=>{ await saveEdit(idx, it.name); }; right.appendChild(btnSave);
          const btnCancel = document.createElement('button'); btnCancel.textContent='Cancel'; btnCancel.onclick=()=>{ cancelEdit(); }; right.appendChild(btnCancel);
        } else {
          const btnEdit = document.createElement('button'); btnEdit.textContent='Edit'; btnEdit.onclick=()=>editItem(idx, it.name); right.appendChild(btnEdit);
          const btnDel = document.createElement('button'); btnDel.textContent='Remove'; btnDel.onclick=async()=>{ await removeItem(it.name); }; right.appendChild(btnDel);
        }
        row.appendChild(right);
        box.appendChild(row);
      });
    }
    async function removeItem(name){ const i=(kit.custom||[]).findIndex(x=>String(x.name)===String(name)); if(i>=0) kit.custom.splice(i,1); else kit.hidden=Array.from(new Set([...(kit.hidden||[]), name])); await persist(); }
    async function addItem(){
      const name=(document.getElementById('newName').value||'').trim();
      const mode=(document.getElementById('newMode').value||'present');
      if(!name) return;
      document.getElementById('newName').value=''; document.getElementById('newMode').value='present';
      const idx=(kit.custom||[]).findIndex(x=>String(x.name)===name);
      const pattern='^'+escapeRe(name)+'$';
      if(idx>=0){ kit.custom[idx].mode=(mode==='count'?'count':'present'); if(!kit.custom[idx].pattern) kit.custom[idx].pattern=pattern; }
      else { kit.custom=(kit.custom||[]).concat([{ name, mode:(mode==='count'?'count':'present'), pattern }]); }
      await persist();
    }
    function editItem(idx, oldName){ window._editingIdx=idx; window._editingName=oldName; render(); }
    function cancelEdit(){ window._editingIdx=-1; window._editingName=''; render(); }
    function escapeRe(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    async function saveEdit(idx, oldName){
      const inp=document.getElementById('edit-name-'+idx);
      const newName=(inp&&inp.value?String(inp.value).trim():'');
      const modeSel=document.getElementById('edit-mode-'+idx);
      const mode=(modeSel&&modeSel.value)||'present';
      window._editingIdx=-1; window._editingName='';
      if(!newName||newName===oldName){ render(); return; }
      const customIdx=(kit.custom||[]).findIndex(x=>String(x.name)===String(oldName));
      if(customIdx>=0){
        kit.custom[customIdx].name=newName;
        kit.custom[customIdx].mode=(mode==='count'?'count':'present');
        if(!kit.custom[customIdx].pattern) kit.custom[customIdx].pattern='^'+escapeRe(newName)+'$';
      } else {
        kit.hidden=Array.from(new Set([...(kit.hidden||[]), oldName]));
        const pattern='^'+escapeRe(newName)+'$';
        kit.custom=(kit.custom||[]).concat([{ name:newName, mode:(mode==='count'?'count':'present'), pattern }]);
      }
      await persist();
    }
    async function resetCustom(){ kit.custom=[]; kit.hidden=[]; await persist(); }
    function showToast(msg, dur=800){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg||''; t.style.display='block'; setTimeout(()=>{ t.style.display='none'; }, dur); }
    async function saveAndClose(){
      // Save instantly and trigger background push without blocking the UI
      try { await window.EQCM.saveRaidKitAndPush({ items: kit.custom, hidden: kit.hidden }); } catch(e) {}
      // Brief toast for user feedback, then close
      showToast('Saved. Syncing in background…', 700);
      setTimeout(()=>{ window.close(); }, 650);
    }
    async function persist(){
      try{
        const payload = { items: normalizeCustom(kit.custom), hidden: kit.hidden||[] };
        await window.EQCM.setRaidKit(payload);
        kit = await window.EQCM.getRaidKit();
        render();
        setStatus('Saved');
      }catch(e){ alert('Save failed: ' + (e && e.message || e)); }
    }
    window.addEventListener('DOMContentLoaded', ()=>{ load(); });
  </script>
</head>
<body>
  <h2>Raid Kit</h2>
  <p class="small">Simple CRUD: add, edit, or remove items from your raid kit. Removing a default item hides it; removing a custom item deletes it.</p>
  <h3>Add Item</h3>
  <div class="row" style="margin-bottom:8px">
    <input id="newName" type="text" placeholder="Item name (e.g., 10 Dose Potion of Stinging Wort)"/>
    <select id="newMode">
      <option value="present">Present</option>
      <option value="count">Count</option>
    </select>
    <button onclick="addItem()">Add</button>
  </div>
  <h3>Items</h3>
  <div class="list" id="kitList"></div>
  <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
    <button onclick="saveAndClose()">Save & Close</button>
    <button onclick="resetCustom()">Reset Custom Items</button>
    <span id="status" class="small" style="color:#555"></span>
  </div>
  <div id="toast"></div>
</body>
</html>
